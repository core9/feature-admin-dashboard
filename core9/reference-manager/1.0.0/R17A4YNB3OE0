// Core9 - Module: module-platform-reference-manager
angular.module("core9Dashboard.refman",["core9Dashboard.refman.app","templates-module-platform-reference-manager"]),angular.module("core9Dashboard.admin.dashboard").requires.push("core9Dashboard.refman"),angular.module("core9Dashboard.refman.app",["ui.router","core9Dashboard.menu","core9Dashboard.config","core9Dashboard.content"]).config(["$stateProvider",function(a){a.state("contentreferences",{url:"/content/references",views:{main:{controller:"ContentReferencesCtrl",templateUrl:"c9refman/refman/references.tpl.html"}},data:{pageTitle:"Content references",sidebar:"content"}})}]).controller("ContentReferencesCtrl",["$scope","ConfigFactory","ContentFactory",function(a,b,c){a.contenttypes=b.query({configtype:"content"}),a.srcSearch={},a.dstSearch={},a.unreferenced=!1,a.$watch("unreferenced",function(){void 0!==a.sourceField&&(a.unreferenced?a.srcSearch[a.sourceField.name]="!":delete a.srcSearch[a.sourceField.name])}),a.getContentRefFields=function(b){if(void 0!==b){var c,d,e=[];for(var f in b)if("widget"===f&&"contentref"===b[f])e.push({name:"this",field:b});else if("object"==typeof b[f])for(c=a.getContentRefFields(b[f]),d=0;d<c.length;d++)"this"===c[d].name?"items"===f?c[d].field.qty="multiple":c[d].name=f:c[d].name=f+"."+c[d].name,e.push(c[d]);return e}},a.reset=function(b,c,d){a[c]={};var e=a[b][d._id];a[b]={},e?(delete a.pivotType,delete a.pivot):(a[b][d._id]=!0,a.pivot=d)},a.setSelectedDestItems=function(){if(void 0!==a.pivot){void 0===a.pivot[a.sourceField.name]&&(a.pivot[a.sourceField.name]=[]);for(var b=a.pivot[a.sourceField.name],c=0;c<b.length;c++)a.destIndex[b[c].value]=!0}},a.srcIndex={},a.selectSource=function(b){if(void 0===a.pivotType&&(a.pivotType="source"),"source"===a.pivotType)a.reset("srcIndex","destIndex",b),a.setSelectedDestItems();else{var c=a.srcIndex[b._id];if(c){for(var d=b[a.sourceField.name],e=0;e<d.length;e++)d[e].value===a.pivot._id&&b[a.sourceField.name].splice(e,1);a.srcIndex[b._id]=!1}else{var f=a.pivot[a.sourceField.field.contentfield],g=a.pivot._id;b[a.sourceField.name].push({key:f,value:g}),a.srcIndex[b._id]=!0}b.$update()}},a.setSelectedSrcItems=function(){for(var b=0;b<a.contentList.length;b++){void 0===a.contentList[b][a.sourceField.name]&&(a.contentList[b][a.sourceField.name]=[]);for(var c=a.contentList[b][a.sourceField.name],d=0;d<c.length;d++)c[d].value===a.pivot._id&&(a.srcIndex[a.contentList[b]._id]=!0)}},a.destIndex={},a.selectDestination=function(b){if(void 0===a.pivotType&&(a.pivotType="destination"),"destination"===a.pivotType)a.reset("destIndex","srcIndex",b),a.setSelectedSrcItems();else{var c=a.destIndex[b._id];if(c){for(var d=a.pivot[a.sourceField.name],e=0;e<d.length;e++)d[e].value===b._id&&a.pivot[a.sourceField.name].splice(e,1);a.destIndex[b._id]=!1}else{var f=b[a.sourceField.field.contentfield],g=b._id;a.pivot[a.sourceField.name].push({value:g,key:f}),a.destIndex[b._id]=!0}a.pivot.$update()}},a.$watch("source",function(){delete a.sourceField,void 0!==a.source&&(a.contentList=c.query({contenttype:a.source.name}),a.contentRefFields=a.getContentRefFields(a.source.schemaOptions))}),a.$watch("sourceField",function(){void 0!==a.sourceField&&(a.referencedList=c.query({contenttype:a.sourceField.field.contenttype}))})}]).run(["MenuService",function(a){a.add("content",{title:"References",weight:50,link:"contentreferences"})}]),angular.module("templates-module-platform-reference-manager",["c9refman/refman/references.tpl.html"]),angular.module("c9refman/refman/references.tpl.html",[]).run(["$templateCache",function(a){a.put("c9refman/refman/references.tpl.html",'<h1 class="page-header">Content references<small><i class="icon-double-angle-right"></i> manage your relations</small></h1>\n<fieldset>\n  <legend>Options</legend>\n  <div class="row">\n  	<div class="col-md-6">\n      <div class="form-group row">\n        <label class="col-md-2 control-label" for="">Source</label>\n        <div class="col-md-10">\n          <button type="button" class="form-control btn btn-default dropdown-toggle">{{source.name}}</button>\n          <ul class="dropdown-menu selectbox">\n            <li ng-repeat="contenttype in contenttypes"><a ng-click="$parent.source = contenttype">{{contenttype.name}}</a></li>\n          </ul>\n        </div>\n      </div>\n    </div>\n    <div class="col-md-6">\n      <div class="form-group row" ng-show="source !== undefined">\n        <label class="col-md-2 control-label" for="">Field</label>\n        <div class="col-md-10">\n          <button type="button" class="form-control btn btn-default dropdown-toggle">{{sourceField.name}}</button>\n          <ul class="dropdown-menu selectbox">\n            <li ng-repeat="field in contentRefFields"><a ng-click="$parent.sourceField = {name: field.name, field: field.field}">{{field.name}}</a></li>\n          </ul>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class="row" ng-show="sourceField !== undefined">\n    <div class="col-md-6">\n      <div class="form-group">\n        <div class="input-group row">\n          <span class="input-group-addon"><i class="fa fa-search"></i></span>\n          <input type="text" class="form-control" placeholder="Search" ng-model="srcSearch.title">\n          <span class="input-group-addon" ng-click="unreferenced = !unreferenced"><i class="fa" ng-class="{\'fa-chain-broken\': unreferenced, \'fa-link\': !unreferenced}" title="Show unreferenced only"></i></span>\n        </div>\n      </div>\n      <div class="form-group">\n        <div class="list-group row">\n          <a ng-repeat="content in contentList | filter:srcSearch" class="list-group-item" ng-class="{active: $parent.srcIndex[content._id] === true}" ng-click="selectSource(content)">{{content.title}}</a>\n        </div>\n      </div>\n    </div>\n    <div class="col-md-6">\n      <div class="form-group">\n        <div class="input-group">\n          <span class="input-group-addon"><i class="fa fa-search"></i></span>\n          <input type="text" class="form-control" placeholder="Search" ng-model="dstSearch[sourceField.field.contentfield]">\n        </div>\n      </div>\n      <div class="form-group">\n        <div class="list-group">\n          <a ng-repeat="reference in referencedList | filter:dstSearch" class="list-group-item" ng-class="{active: $parent.destIndex[reference._id] === true}" ng-click="selectDestination(reference)">{{reference[sourceField.field.contentfield]}}</a>\n        </div>\n      </div>\n    </div>\n  </div>\n</fieldset>')}]);