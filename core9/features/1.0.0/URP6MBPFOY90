// Core9 - Module: module-cms-features
angular.module("core9Dashboard.feature.config",["core9Dashboard.config"]).controller("FeaturesConfigurationCtrl",["$scope","ConfigFactory","$http",function(a,b,c){a.repos=b.query({configtype:"featuresrepo_ext"}),a.save=function(a){a.$update()},a.addRepo=function(c,d,e){if(void 0!==c){var f=new b;f.path=c,f.user=d,f.password=e,f.$save({configtype:"featuresrepo_ext"},function(b){a.repos.push(b)})}},a.deleteRepo=function(c){c.$remove(function(){a.repos=b.query({configtype:"featuresrepo_ext"})})},a.downloadRepo=function(b){c.post("/admin/featurerepository/"+b._id+"?pull").success(function(){alert("Success")}).error(function(b){a.$emit("$error",b)})},a.uploadRepo=function(b){c.post("/admin/featurerepository/"+b._id+"?push").success(function(){alert("Success")}).error(function(b){a.$emit("$error",b)})}}]),angular.module("core9Dashboard.feature",["ui.router","core9Dashboard.menu","core9Dashboard.config","core9Dashboard.content","core9Dashboard.feature.config","core9Dashboard.feature.processor.content","core9Dashboard.feature.processor.config"]).config(["$stateProvider",function(a){a.state("features",{url:"/config/features",views:{main:{controller:"ConfigFeaturesListCtrl",templateUrl:"features/features.tpl.html"}},data:{pageTitle:"Features"}}).state("editfeature",{url:"/config/features/:repo/{feature:.*}",views:{main:{controller:"ConfigFeaturesFeatureCtrl",templateUrl:"features/feature.tpl.html"}},data:{pageTitle:"Feature"}})}]).controller("ConfigFeaturesListCtrl",["$scope","$state","ConfigFactory","$http",function(a,b,c,d){c.query({configtype:"featuresrepo_int"},function(b){0===b.length?(a.internal=new c,a.internal.current={},a.internal.$save({configtype:"featuresrepo_int"})):a.internal=b[0]}),a.apply=function(b,c,e){var f={repo:b,feature:c.name,version:e};d.post("/admin/features/apply",f).success(function(){a.internal.$get()})},a.edit=function(a,c){b.go("editfeature",{repo:a,feature:c})},a.deactivate=function(b,c){var e={repo:b,feature:c.name};d.post("/admin/features/disable",e).success(function(){a.internal.$get()})}}]).controller("ConfigFeaturesInternalCtrl",["$scope","$http","ConfigFactory",function(a,b){a.$watch("internal",function(){void 0!==a.internal&&b.get("/admin/featurerepository/"+a.internal._id).success(function(b){a.features=b}).error(function(b){a.$emit("$error",b)})}),a.add=function(b){a.edit(a.internal._id,b)}}]).controller("ConfigFeaturesExternalCtrl",["$scope","$http","ConfigFactory",function(a,b,c){c.query({configtype:"featuresrepo_ext"},function(b){a.repos=b}),a.openRepo=function(c){c===a.activeRepo?a.activeRepo=null:(a.activeRepo=c,b.get("/admin/featurerepository/"+c).success(function(b){a.features=b}))}}]).controller("ConfigFeaturesFeatureCtrl",["$scope","$http","$state","$stateParams",function(a,b,c,d){b.get("/admin/featurerepository/"+d.repo+"/"+encodeURIComponent(d.feature)).success(function(b){a.feature=""===b?{name:d.feature}:b}).error(function(b){a.$emit("$error",b)}),b.get("/admin/features?getTypes").success(function(b){a.featureTypes=b}),a.save=function(){b.put("/admin/featurerepository/"+d.repo+"/"+encodeURIComponent(d.feature),a.feature).success(function(b){a.feature=b,alert("Saved")})},a.removeFeature=function(){var a=confirm("Do you really want to delete the entire feature? Click OK if you are sure.");a&&b["delete"]("/admin/featurerepository/"+d.repo+"/"+encodeURIComponent(d.feature)).success(function(){c.go("features")})},a.removeVersion=function(){var c=confirm("Do you really want to delete this version? Click OK if you are sure.");c&&b["delete"]("/admin/featurerepository/"+d.repo+"/"+encodeURIComponent(d.feature)+"-v"+a.selectedVersion).success(function(b){a.feature=b,a.selectedVersion=!1})},a.addVersion=function(b){void 0===a.feature.versions&&(a.feature.versions=[]),void 0!==b&&null!==b&&""!==b?(a.feature.versions.push(b),a.save()):alert("Enter a version name/number.")},a.saveVersion=function(){b.put("/admin/featurerepository/"+d.repo+"/"+encodeURIComponent(d.feature)+"-v"+a.selectedVersion,a.version).success(function(b){a.version=b,alert("Saved"),a.selectedVersion=!1})},a.updateVersion=function(){b.post("/admin/featurerepository/"+d.repo+"/"+encodeURIComponent(d.feature)+"-v"+a.selectedVersion).success(function(b){a.version=b,alert("Your contents are updated.")})},a.selectedVersion=!1,a.select=function(b){var c=!0;a.selectedVersion!==!1&&(c=confirm("Do you really want to change versions? Your changes will be lost, click save to persist them.")),c&&(a.selectedVersion=b===a.selectedVersion?!1:b)},a.$watch("selectedType",function(b,c){b!==c&&void 0!==b&&void 0===a.version[b]&&(a.version[b]=[])}),a.$watch("selectedVersion",function(c,e){c!==e&&void 0!==c&&c!==!1?b.get("/admin/featurerepository/"+d.repo+"/"+encodeURIComponent(d.feature)+"-v"+a.selectedVersion).success(function(b){a.version=b}):delete a.selectedType})}]).directive("cnFeatureProcessor",["$compile","$templateCache",function(a,b){return{replace:!0,scope:{template:"=cnProcessorTemplate",selected:"=cnSelectedItems"},link:function(c,d){d.html('<div><i class="fa fa-spinner fa-spin"></i> Loading</div>'),a(d.contents())(c),c.$watch("template",function(e,f){e!==f&&void 0!==e&&(d.html(b.get(e)),a(d.contents())(c))})}}}]).run(["MenuService",function(a){a.add("config",{title:"Features",weight:300,link:"/config/features"})}]),angular.module("core9Dashboard.feature.processor.config",["ui.bootstrap","core9Dashboard.config"]).controller("FeatureProcessorConfigCtrl",["$scope","$modal",function(a,b){a.deselect=function(b){a.$parent.selected.splice(b,1)},a.add=function(){b.open({templateUrl:"features/processor/config.modal.tpl.html",controller:"FeatureProcessorConfigModalCtrl",resolve:{selected:function(){return a.$parent.selected}}})}}]).controller("FeatureProcessorConfigModalCtrl",["$scope","$http","$modalInstance","ConfigFactory","selected",function(a,b,c,d,e){b.get("/admin/config?listtypes").success(function(b){a.configtypes=b}),a.contenttypes=d.query({configtype:"content"}),a.$watch("configtype",function(){void 0!==a.configtype&&(a.configlist=d.query({configtype:a.configtype}))}),a.isSelected=function(a){for(var b=0;b<e.length;b++)if(e[b].id===a)return!0;return!1},a.select=function(a){for(var b=!1,c=0;c<e.length;c++)e[c].id===a._id&&(b=!0,e.splice(c,1));b||e.push({id:a._id,entry:a})},a.ok=function(){c.close()}}]),angular.module("core9Dashboard.feature.processor.content",["core9Dashboard.config","core9Dashboard.config.content","core9Dashboard.content"]).controller("FeatureProcessorContentCtrl",["$scope","$modal",function(a,b){a.deselect=function(b){a.$parent.selected.splice(b,1)},a.add=function(){b.open({templateUrl:"features/processor/content.modal.tpl.html",controller:"FeatureProcessorContentModalCtrl",resolve:{selected:function(){return a.$parent.selected}}})}}]).controller("FeatureProcessorContentModalCtrl",["$scope","$modalInstance","ConfigFactory","ContentFactory","selected",function(a,b,c,d,e){a.contenttypes=c.query({configtype:"content"}),a.$watch("contenttype",function(){void 0!==a.contenttype&&void 0!==a.contenttype.name&&(a.contentlist=d.query({contenttype:a.contenttype.name}))}),a.isSelected=function(b){for(var c=a.contenttype.name+"-"+b,d=0;d<e.length;d++)if(e[d].id===c)return!0;return!1},a.select=function(b){for(var c=!1,d=a.contenttype.name+"-"+b._id,f=0;f<e.length;f++)e[f].id===d&&(c=!0,e.splice(f,1));c||e.push({id:d,entry:b})},a.ok=function(){b.close()}}]),angular.module("core9Dashboard.features",["core9Dashboard.feature","templates-module-cms-features"]),angular.module("templates-module-cms-features",["features/config/configuration.tpl.html","features/external.tpl.html","features/feature.tpl.html","features/features.tpl.html","features/internal.tpl.html","features/processor/config.modal.tpl.html","features/processor/config.tpl.html","features/processor/content.modal.tpl.html","features/processor/content.tpl.html"]),angular.module("features/config/configuration.tpl.html",[]).run(["$templateCache",function(a){a.put("features/config/configuration.tpl.html",'<div ng-controller="FeaturesConfigurationCtrl">\n	<fieldset>\n		<legend>Configuration</legend>\n		<tabset>\n			<tab heading="Git">\n				<h3>Git repositories</h3>\n				<p>You can manager your external git repositories over here. For anonymous checkout, please use the https URL.</p>\n				<table class="table table-striped">\n					<tr>\n						<th>ID</th>\n						<th>Repository</th>\n						<th>Username</th>\n						<th>Actions</th>\n					</tr>\n					<tr>\n						<td>{{internal._id}}</td>\n						<td>{{internal.path}}</td>\n						<td>{{internal.user}}</td>\n						<td>\n							<a class="btn btn-success" ng-click="downloadRepo(internal)"><i class="fa fa-cloud-download"></i></i></a>\n							<a class="btn btn-danger" ng-click="uploadRepo(internal)"><i class="fa fa-cloud-upload"></i></i></a>\n						</td>\n					<tr ng-show="repos.length > 0">\n						<th colspan="4">External repositories</th>\n					</tr>\n					<tr ng-repeat="repo in repos">\n						<td>{{repo._id}}</td>\n						<td>{{repo.path}}</td>\n						<td>{{repo.user}}</td>\n						<td>\n							<a class="btn btn-success" ng-click="downloadRepo(repo)"><i class="fa fa-cloud-download"></i></i></a>\n							<a class="btn btn-danger" ng-click="deleteRepo(repo)"><i class="fa fa-trash-o"></i></a>\n						</td>\n					</tr>\n				</table>\n				<fieldset>\n					<legend>Actions</legend>\n					<div class="pull-right">\n						<button class="btn btn-success" ng-click="showAddRepo = !showAddRepo" ng-show="!showAddRepo">Add external repository</button>\n						<button class="btn btn-warning" ng-click="showInternalRepo = !showInternalRepo" ng-show="!showInternalRepo">Edit internal repository</button>\n					</div>\n				</fieldset>\n				<fieldset ng-show="showInternalRepo">\n					<legend>Internal repository</legend>\n					<div class="input-group">\n						<span class="input-group-addon">Repository path</span>\n						<input type="text" class="form-control" ng-model="internal.path" />\n					</div>\n					<div class="input-group">\n						<span class="input-group-addon">Username</span>\n						<input type="text" class="form-control" ng-model="internal.user" />\n					</div>\n					<div class="input-group">\n						<span class="input-group-addon">Password</span>\n						<input type="password" class="form-control" ng-model="internal.password" />\n					</div>\n					<div class="pull-right">\n						<button class="btn btn-success" ng-click="save(internal); showInternalRepo = !showInternalRepo">Save</button>\n						<button class="btn btn-warning" ng-click="showInternalRepo = !showInternalRepo">Cancel</button>\n					</div>\n				</fieldset>\n				<fieldset ng-show="showAddRepo">\n					<legend>Add external repository</legend>\n					<div class="input-group">\n						<span class="input-group-addon">Repository path</span>\n						<input type="text" class="form-control" ng-model="newPath" />\n					</div>\n					<div class="input-group">\n						<span class="input-group-addon">Username</span>\n						<input type="text" class="form-control" ng-model="newUser" />\n					</div>\n					<div class="input-group">\n						<span class="input-group-addon">Password</span>\n						<input type="password" class="form-control" ng-model="newPassword" />\n					</div>\n					<button class="btn btn-success pull-right" ng-click="addRepo(newPath,newUser,newPassword); showAddRepo = !showAddRepo">Add</button>\n				</fieldset>\n			</tab>\n		</tabset>\n	</fieldset>\n	<hr />\n</div>\n')}]),angular.module("features/external.tpl.html",[]).run(["$templateCache",function(a){a.put("features/external.tpl.html",'<h4>External features</h4>\n<p>These are external features, you can add new feature repositories via the settings panel (gears icon).</p>\n<table class="table table-striped">\n	<tbody ng-repeat="repo in repos">\n		<tr>\n			<th>Repository:</th>\n			<th ng-click="openRepo(repo._id)" colspan="3">{{repo.path}}</th>\n		</tr>\n		<tr ng-if="activeRepo == repo._id">\n			<th>Feature name</th>\n			<th>Description</th>\n			<th>Versions</th>\n			<th>Actions</th>\n		</tr>\n		<tr ng-if="activeRepo == repo._id" ng-repeat="feature in features">\n			<td>{{feature.name}}</td>\n			<td>{{feature.description}}</td>\n			<td>\n				<select ng-options="version as version for version in feature.versions" ng-model="repo.current[feature.name]"></select>\n			</td>\n			<td>\n				<button class="btn btn-success" ng-show="repo.current[feature.name] !== undefined" ng-click="apply(repo._id, feature, repo.current[feature.name])">Apply</button>\n				<button class="btn btn-danger" ng-show="repo.current[feature.name] != undefined" ng-click="deactivate(repo._id, feature)">Deactivate</button>\n			</td>\n		</tr>\n	</tbody>\n</table>\n\n')}]),angular.module("features/feature.tpl.html",[]).run(["$templateCache",function(a){a.put("features/feature.tpl.html",'<div class="row">\n	<h2>Feature {{feature.name}}</h2>\n	<p>You can edit your feature right here, add versions or modify existing versions</p>\n	<!-- Text input-->\n	<div class="row">\n		<label class="col-md-3 control-label">Feature name</label>  \n		<div class="col-md-9">\n			<input id="Feature name" ng-model="feature.name" type="text" placeholder="The name for your feature" class="form-control input-md" required="" />\n		</div>\n	</div>\n	<div class="row">\n		<label class="col-md-3 control-label">Description</label>\n		<div class="col-md-9">                     \n			<textarea class="form-control" id="description" ng-model="feature.description"></textarea>\n		</div>\n	</div>\n</div>\n\n<div class="row">\n	<fieldset>\n		<legend>Versions</legend>\n		<div class="col-xs-12 col-md-4">\n			<h4>Version</h4>\n			<ul class="nav nav-pills nav-stacked">\n				<li ng-repeat="version in feature.versions" ng-click="select(version)" ng-class="{active: $parent.selectedVersion == version, disabled: $parent.selectedVersion}">\n					<a>{{version}}</a>\n				</li>\n			</ul>\n			<div class="input-group">\n				<input type="text" class="form-control" ng-model="versionName" placeholder="e.g. 0.1.5">\n				<span class="input-group-btn">\n					<button class="btn btn-success" ng-click="addVersion(versionName)">Add version</button>\n				</span>\n			</div>\n		</div>\n		<div class="col-xs-12 col-md-4" ng-show="selectedVersion">\n			<h4>Feature Type</h4>\n			<ul class="nav nav-pills nav-stacked">\n				<li ng-repeat="(type, template) in featureTypes" ng-click="$parent.selectedType = type" ng-class="{active: $parent.selectedType == type}">\n					<a>{{type}}</a>\n				</li>\n			</ul>\n		</div>\n		<div class="col-xs-12 col-md-4" ng-show="selectedType">\n			<h4>Contents</h4>\n			<div cn-feature-processor cn-processor-template="featureTypes[selectedType]" cn-selected-items="version[selectedType]"></div>\n		</div>\n	</fieldset>\n</div>\n<div class="row" ng-show="selectedVersion">\n	<fieldset>\n		<legend>Version actions</legend>\n		<button class="btn btn-success" ng-click="saveVersion()">Save</button>\n		<button class="btn btn-warning" ng-click="updateVersion()">Update selected content</button>\n		<button class="btn btn-danger" ng-click="removeVersion()">Delete selected version</button>\n	</fieldset>\n</div>\n<div class="row">\n	<fieldset>\n		<legend>Actions</legend>\n		<div class="pull-right">\n			<button class="btn btn-danger" ng-click="removeFeature()">Delete entire feature</button>\n			<button class="btn btn-success" ng-click="save()">Save</button>\n		</div>\n	</fieldset>\n</div>')}]),angular.module("features/features.tpl.html",[]).run(["$templateCache",function(a){a.put("features/features.tpl.html",'<div>\n	<h2>Features <a ng-click="showConfig = !showConfig"><i class="fa fa-cogs pull-right"></i></a></h2>\n	<p>Manage your features in this section. A feature is a set of content, configuration or files. These sets can be exported to and imported from the features</p>\n	<div ng-if="showConfig" ng-include="\'features/config/configuration.tpl.html\'">\n	</div>\n	<tabset ng-show="!showConfig">\n		<tab heading="Internal" ng-controller="ConfigFeaturesInternalCtrl">\n			<div ng-include="\'features/internal.tpl.html\'"></div>\n		</tab>\n		<tab heading="External" ng-controller="ConfigFeaturesExternalCtrl">\n			<div ng-include="\'features/external.tpl.html\'"></div>\n		</tab>\n	</tabset>\n</div>')}]),angular.module("features/internal.tpl.html",[]).run(["$templateCache",function(a){a.put("features/internal.tpl.html",'<h4>Internal features</h4>\n<p>These are your internal features, they can only be accessed by your own site.</p>\n<table class="table table-striped">\n	<tr>\n		<th>Feature name</th>\n		<th>Description</th>\n		<th>Versions</th>\n		<th>Actions</th>\n	</tr>\n	<tr ng-repeat="feature in features">\n		<td>{{feature.name}}</td>\n		<td>{{feature.description}}</td>\n		<td>\n			<select ng-options="version as version for version in feature.versions" ng-model="internal.current[feature.name]"></select>\n		</td>\n		<td>\n			<button class="btn btn-success" ng-show="internal.current[feature.name] !== undefined" ng-click="apply(internal._id, feature, internal.current[feature.name])">Apply</button>\n			<button class="btn btn-warning" ng-click="edit(internal._id, feature.name)">Edit</button>\n			<button class="btn btn-danger" ng-show="internal.current[feature.name] != undefined" ng-click="deactivate(internal._id, feature)">Deactivate</button>\n		</td>\n	</tr>\n</table>\n<div class="pull-right col-md-6">\n	<div class="input-group">\n		<input type="text" class="form-control" ng-model="featureName" placeholder="e.g. blog">\n		<span class="input-group-btn">\n			<button class="btn btn-success" ng-click="add(featureName)">Add feature</button>\n		</span>\n	</div>\n</div>')}]),angular.module("features/processor/config.modal.tpl.html",[]).run(["$templateCache",function(a){a.put("features/processor/config.modal.tpl.html",'<div>\n    <div class="modal-header">\n        <h3>Select your config</h3>\n    </div>\n    <div class="modal-body">\n        <label>Configuration type</label>\n        <select ng-options="type as type for type in configtypes" ng-model="$parent.configtype"></select>\n        <table class="table table-striped" ng-show="configlist.length > 0">\n            <thead>\n                <tr>\n                    <th>ID</th>\n                    <th>Name</th>\n                </tr>\n            </thead>\n            <tbody>\n                <tr ng-repeat="config in configlist">\n                    <td ng-click="select(config)" ng-class="{\'bg-success\': isSelected(config._id)}">{{config._id}}</td>\n                    <td ng-click="select(config)" ng-class="{\'bg-success\': isSelected(config._id)}">{{config.name}}</td>\n                </tr>\n            </tbody>\n        </table>\n    </fieldset>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary" ng-click="ok()">OK</button>\n</div>\n</div>')}]),angular.module("features/processor/config.tpl.html",[]).run(["$templateCache",function(a){a.put("features/processor/config.tpl.html",'<div ng-controller="FeatureProcessorConfigCtrl">\n	<button class="btn btn-success" ng-click="add()" style="width: 100%">Add configuration</button>\n</div>')}]),angular.module("features/processor/content.modal.tpl.html",[]).run(["$templateCache",function(a){a.put("features/processor/content.modal.tpl.html",'<div>\n    <div class="modal-header">\n        <h3>Select your content</h3>\n    </div>\n    <div class="modal-body">\n        <label>Content type</label>\n        <select ng-options="type as type.label for type in contenttypes" ng-model="$parent.contenttype"></select>\n        <table class="table table-striped" ng-show="contentlist.length > 0">\n            <thead>\n                <tr>\n                    <th>ID</th>\n                    <th ng-repeat="(fieldname, field) in contenttype.schema.properties" ng-show="contenttype.schemaOptions[fieldname].showInList">\n                        {{contenttype.schemaOptions[fieldname].label}}\n                    </th>\n                </tr>\n            </thead>\n            <tbody>\n                <tr ng-repeat="content in contentlist">\n                    <td ng-click="select(content)" ng-class="{\'bg-success\': isSelected(content._id)}">{{content._id}}</td>\n                    <td ng-repeat="(fieldname, field) in contenttype.schema.properties" ng-show="contenttype.schemaOptions[fieldname].showInList" ng-click="select(content)" ng-class="{\'bg-success\': isSelected(content._id)}">\n                        {{content[fieldname]}}\n                    </td>\n                </tr>\n            </tbody>\n        </table>\n    </fieldset>\n</div>\n<div class="modal-footer">\n    <button class="btn btn-primary" ng-click="ok()">OK</button>\n</div>\n</div>')}]),angular.module("features/processor/content.tpl.html",[]).run(["$templateCache",function(a){a.put("features/processor/content.tpl.html",'<div ng-controller="FeatureProcessorContentCtrl">\n	<button class="btn btn-success" ng-click="add()" style="width: 100%">Add content</button>\n	<h6>Selected (<a ng-click="showSelected = !showSelected">toggle</a>)</h6>\n	<ul class="list-group" ng-show="showSelected">\n		<li ng-repeat="item in selected" class="list-group-item" ng-click="deselect($index)">\n			<a>{{item.id}}</a>\n		</li>\n	</ul>\n</div>')}]);