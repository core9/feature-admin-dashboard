// Core9 - Module: plugin-files-manager-admin
angular.module("core9Dashboard.files.feature",["ui.bootstrap","core9Dashboard.files"]).controller("FeatureProcessorFilesCtrl",["$scope","$modal",function(a,b){a.add=function(){b.open({templateUrl:"files/featureprocessor/processor.modal.tpl.html",controller:"FeatureProcessorFilesModalCtrl",resolve:{selected:function(){return a.$parent.selected}}})}}]).controller("FeatureProcessorFilesModalCtrl",["$scope","$modalInstance","FileFactory","selected",function(a,b,c,d){a.folder="/",a.files=c.query({folder:a.folder}),a.switchTo=function(b){var c="/";if("/"===b){var d=a.folder.substring(0,a.folder.length-1).lastIndexOf("/");c=a.folder.substring(0,d)+b}else c=a.folder+b+"/";a.folder=c},a.$watch("folder",function(){void 0!==a.folder&&(a.files=c.query({folder:a.folder}))}),a.isSelected=function(a){for(var b=0;b<d.length;b++)if(d[b].id===a&&void 0===d[b].remove)return!0;return!1},a.select=function(a){for(var b=!1,c=0;c<d.length;c++)d[c].id===a._id&&(b=!0,d[c].remove=!0);b||d.push({id:a._id,entry:a})},a.ok=function(){b.close()}}]),angular.module("core9Dashboard.files",["ui.router","ui.bootstrap","ngResource","angularFileUpload","core9Dashboard.menu","core9Dashboard.config","ui.codemirror"]).factory("FileFactory",["$resource",function(a){return a("/admin/files/:fileid",{fileid:"@_id"},{update:{method:"PUT"}})}]).factory("FileViewer",["$templateCache",function(a){function b(a){angular.copy(a,this)}var c={},d={};return b.get=function(a){return new b(c[a])},b.getForContentType=function(a){return console.log(a),c[d[a]]},b.getAll=function(){var a=[];for(var b in c)a.push(b);return a},b.prototype.addContentType=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)d[a[b]]=this.name;else d[a]=this.name;return this},b.prototype.save=function(){return c[this.name]=this,c[this.name]},b.prototype.render=function(){return a.get(this.template)},b}]).config(["$stateProvider",function(a){a.state("files",{url:"/config/files",views:{main:{controller:"FilesCtrl",templateUrl:"files/files.tpl.html"}},data:{pageTitle:"Files",sidebar:"config",context:"filescontext"}}).state("fileedit",{url:"/config/files/:id?bucket",views:{main:{controller:"EditFileCtrl",templateUrl:"files/edit.tpl.html"}},data:{pageTitle:"Files",sidebar:"config",context:"filescontext"}}).state("filessettings",{url:"/config/filessettings",views:{main:{controller:"FilesSettingsCtrl",templateUrl:"files/settings.tpl.html"}},data:{pageTitle:"Files",sidebar:"config",context:"filescontext"}}).state("filesbucket",{url:"/config/filessettings/:bucketid",views:{main:{controller:"FilesSettingsBucketCtrl",templateUrl:"files/bucket/edit.tpl.html"}},resolve:{bucket:["ConfigFactory","$stateParams",function(a,b){return a.get({configtype:"bucket",id:b.bucketid})}]},data:{pageTitle:"Files",sidebar:"config",context:"filescontext"}})}]).controller("FilesCtrl",["$scope","$state","$location","FileFactory","ConfigFactory",function(a,b,c,d,e){a.buckets=e.query({configtype:"bucket"}),a.standardBucket={name:"Standard"},a.selectBucket=function(b){a.selectedBucket=b,a.folder="/"},a.$watch("selectedBucket",function(){void 0!==a.selectedBucket&&void 0!==a.selectedBucket._id&&c.search("bucket",a.selectedBucket._id),a.update()});var f=c.search().dir;a.folder=void 0!==f&&null!==f?f:"/";var g=c.search().bucket;void 0!==g&&null!==g?e.get({configtype:"bucket",id:g},function(b){a.selectedBucket=b}):a.selectedBucket=a.standardBucket,a.addFile=function(){var c=new d;c.filename="ReplaceMe",c.metadata={folder:a.folder,type:"File"},void 0!==a.selectedBucket&&void 0!==a.selectedBucket._id?c.$save({bucket:a.selectedBucket._id},function(c){a.files.push(c),b.go("fileedit",{id:c._id,bucket:a.selectedBucket._id})}):c.$save(function(c){a.files.push(c),b.go("fileedit",{id:c._id})})},a.edit=function(c){void 0!==a.selectedBucket._id?b.go("fileedit",{id:c._id,bucket:a.selectedBucket._id}):b.go("fileedit",{id:c._id})},a.switchTo=function(b){var c="/";if("/"===b){var d=a.folder.substring(0,a.folder.length-1).lastIndexOf("/");c=a.folder.substring(0,d)+b}else c=a.folder+b+"/";a.folder=c},a.update=function(){a.files=d.query(void 0!==a.selectedBucket&&void 0!==a.selectedBucket._id?{folder:a.folder,bucket:a.selectedBucket._id}:{folder:a.folder})},a.remove=function(b){void 0!==a.selectedBucket&&void 0!==a.selectedBucket._id?b.$remove({bucket:a.selectedBucket._id},function(){a.update()}):b.$remove(function(){a.update()})},a.$watch("folder",function(){void 0!==a.folder&&(c.search("dir",a.folder),a.update())})}]).controller("EditFileCtrl",["$scope","$location","FileFactory","$stateParams","FileViewer",function(a,b,c,d){var e=b.search().bucket;a.mimeTypes={txt:"text/plain",css:"text/css",less:"text/less",jpg:"image/jpeg",dir:"inode/directory",js:"application/javascript"},void 0!==e&&null!==e?(a.file=c.get({fileid:d.id,bucket:e}),console.log(a.file),a.suffix="bucket="+e):(a.file=c.get({fileid:d.id}),a.suffix=""),a.types=["Directory","File"],a.save=function(){void 0!==e&&null!==e?a.file.$update({bucket:e},function(){a.back()}):a.file.$update(function(){a.back()})},a.$watch("file.metadata.type",function(b){"Directory"===b&&(a.file.contentType="inode/directory")}),a.$watch("file.filename",function(b,c){if(void 0!==b&&void 0!==c&&"File"===a.file.metadata.type){var d=b.substring(b.lastIndexOf(".")+1);void 0!==a.mimeTypes[d]&&(a.file.contentType=a.mimeTypes[d])}}),a.back=function(){b.path("/config/files").search("dir",a.file.metadata.folder)}}]).controller("FilesSettingsCtrl",["$scope","$state","ConfigFactory",function(a,b,c){a.buckets=c.query({configtype:"bucket"}),a.add=function(b,d){var e=new c;e.configtype="bucket",e.name=b,e.database=d,e.$save(function(){a.buckets.push(e),a.edit(e)})},a.edit=function(a){b.go("filesbucket",{bucketid:a._id})},a.remove=function(b,c){b.$remove(function(){a.buckets.splice(c,1)})}}]).controller("FilesSettingsBucketCtrl",["$scope","$state","bucket",function(a,b,c){a.bucket=c,a.save=function(){a.bucket.$update(function(){b.go("filessettings")})}}]).directive("cnFileEditor",["FileViewer","$compile",function(a,b){return{replace:!0,scope:{filename:"@",filetype:"="},link:function(c,d){c.$watch("filetype",function(e){d.html(""),b(d.contents())(c),void 0!==e&&(d.html(a.getForContentType(c.filetype).render()),b(d.contents())(c))})}}}]).controller("FileUploadCtrl",["$scope","$location","$upload","FileFactory",function(a,b,c,d){var e=b.search().bucket,f=function(a){console.log("percent: "+parseInt(100*a.loaded/a.total))},g=function(){a.$parent.files=d.query(void 0!==e&&null!==e?{folder:a.$parent.folder,bucket:e}:{folder:a.$parent.folder})};a.onFileSelect=function(b){for(var d=0;d<b.length;d++){var h=b[d];a.upload=void 0!==e&&null!==e?c.upload({url:"admin/files?bucket="+e,file:h,fileFormDataName:a.$parent.folder}).progress(f).success(g):c.upload({url:"admin/files",file:h,fileFormDataName:a.$parent.folder}).progress(f).success(g)}}}]).controller("CoreLessController",["$scope","$http",function(a,b){a.editorOptions={mode:"less",fullScreen:!1,lineWrapping:!0,lineNumbers:!0,onLoad:function(){b.get(a.filename).success(function(b){a.fileContents=b})}},a.save=function(){b.put(a.filename,{content:a.fileContents}).error(function(){alert("Failed, see output in backend console.")})}}]).controller("CoreTextController",["$scope","$http",function(a,b){a.editorOptions={fullScreen:!1,lineWrapping:!0,lineNumbers:!0,onLoad:function(){b.get(a.filename).success(function(b){a.fileContents=b})}},a.save=function(){b.put(a.filename,{content:a.fileContents}).error(function(){alert("Failed, see output in backend console.")})}}]).controller("coreFileSelectorCtrl",["$scope","$modal",function(a,b){a.browse=function(){var c=b.open({templateUrl:"files/field/file.selector.tpl.html",controller:"coreFileSelectorBrowserCtrl",resolve:{folder:function(){return null!==a.options.filepath?a.options.filepath:"/"}}});c.result.then(function(b){void 0!==b&&(a.$parent.data="/static"+b)})}}]).controller("coreFileSelectorBrowserCtrl",["$scope","$modalInstance","folder","FileFactory",function(a,b,c,d){a.folder=c,a.files=d.query({folder:a.folder}),a.switchTo=function(b){var c="/";if("/"===b){var d=a.folder.substring(0,a.folder.length-1).lastIndexOf("/");c=a.folder.substring(0,d)+b}else c=a.folder+b+"/";a.folder=c},a.select=function(b){a.selected=b},a.ok=function(){void 0!==a.selected?b.close(a.folder+a.selected.filename):a.cancel()},a.cancel=function(){b.close()},a.$watch("folder",function(){void 0!==a.folder&&(a.files=d.query({folder:a.folder}))})}]).run(["MenuService","FileViewer","FieldConfig",function(a,b,c){a.add("config",{title:"Files",weight:150,link:"files"}),a.add("filescontext",{title:"Settings",weight:150,link:"filessettings"}),new b({name:"image",template:"files/viewer/image.tpl.html"}).addContentType(["image/bmp","image/cis-cod","image/gif","image/ief","image/jpeg","image/jpeg","image/jpeg","image/pipeg","image/svg+xml","image/tiff","image/tiff","image/x-cmu-raster","image/x-cmx","image/x-icon","image/x-portable-anymap","image/x-portable-bitmap","image/x-portable-graymap","image/x-portable-pixmap","image/x-rgb","image/x-xbitmap","image/x-xpixmap","image/x-xwindowdump"]).save(),new b({name:"less",template:"files/viewer/less.tpl.html"}).addContentType(["text/css","text/less"]).save(),new b({name:"text",template:"files/viewer/text.tpl.html"}).addContentType(["text/plain","application/javascript"]).save(),new c({type:"file"}).addWidget("file",{template:"files/field/file.tpl.html",config:"files/field/file.config.tpl.html"}).save(),c.get("string").addWidget("file",{template:"files/field/file.tpl.html",config:"files/field/file.config.tpl.html"}).save()}]),angular.module("core9Dashboard.filesmanager",["core9Dashboard.files","core9Dashboard.files.feature","templates-plugin-files-manager-admin"]),angular.module("core9Dashboard.admin.dashboard").requires.push("core9Dashboard.filesmanager"),angular.module("templates-plugin-files-manager-admin",["files/bucket/edit.tpl.html","files/edit.tpl.html","files/featureprocessor/processor.modal.tpl.html","files/featureprocessor/processor.tpl.html","files/field/file.config.tpl.html","files/field/file.selector.tpl.html","files/field/file.tpl.html","files/files.tpl.html","files/settings.tpl.html","files/viewer/image.tpl.html","files/viewer/less.tpl.html","files/viewer/text.tpl.html"]),angular.module("files/bucket/edit.tpl.html",[]).run(["$templateCache",function(a){a.put("files/bucket/edit.tpl.html",'<h1 class="page-header">Edit bucket settings</h1>\n<div class="form-group row">\n  <label class="col-md-2 control-label">Bucket name</label>\n  <div class="col-md-8">\n    <input type="text" ng-model="bucket.name" class="form-control input-md" />\n  </div>\n</div>\n<div class="form-group row">\n  <label class="col-md-2 control-label">Bucket database</label>\n  <div class="col-md-8">\n    <input type="text" ng-model="bucket.database" class="form-control input-md" />\n  </div>\n</div>\n<div class="form-group row">\n  <label class="col-md-2 control-label">Database host</label>\n  <div class="col-md-8">\n    <input type="text" ng-model="bucket.host" class="form-control input-md" />\n  </div>\n</div>\n<div class="form-group row">\n  <label class="col-md-2 control-label">Database username</label>\n  <div class="col-md-8">\n    <input type="text" ng-model="bucket.username" class="form-control input-md" />\n  </div>\n</div>\n<div class="form-group row">\n  <label class="col-md-2 control-label">Database password</label>\n  <div class="col-md-8">\n    <input type="text" ng-model="bucket.password" class="form-control input-md" />\n  </div>\n</div>\n<div class="form-group row">\n  <label class="col-md-2 control-label">Bucket path prefix</label>\n  <div class="col-md-8">\n    <input type="text" ng-model="bucket.prefix" class="form-control input-md" />\n    <span class="help-block">The path under which all your files will be available for the web, use none if you want a private file bucket.</span>\n  </div>\n</div>\n<fieldset>\n  <legend>Actions</legend>\n  <button class="btn btn-success" ng-click="save()">Save</button>\n</fieldset>')}]),angular.module("files/edit.tpl.html",[]).run(["$templateCache",function(a){a.put("files/edit.tpl.html",'<h1 class="page-header">File <small>{{file.filename}}</small></h1>\n<fieldset>\n	<legend>File properties</legend>\n  <div class="form-group row">\n    <label class="col-md-2 control-label">Type</label>  \n    <div class="col-md-8">\n      <button type="button" class="btn btn-default form-control dropdown-toggle">{{file.metadata.type}}<span class="caret"></span></button>\n      <ul class="dropdown-menu selectbox">\n        <li ng-repeat="type in types"><a ng-click="file.metadata.type = type">{{type}}</a></li>\n      </ul>\n    </div>\n  </div>\n  <div class="form-group row">\n    <label class="col-md-2 control-label">Name</label>  \n    <div class="col-md-8">\n      <input type="text" placeholder="placeholder" ng-model="file.filename" class="form-control input-md">\n    </div>\n  </div>\n	<div class="form-group row">\n    <label class="col-md-2 control-label">Content Type</label>  \n    <div class="col-md-8">\n      <input type="text" placeholder="placeholder" ng-model="file.contentType" class="form-control input-md">\n    </div>\n  </div>\n</fieldset>\n<fieldset>\n	<legend ng-click="showPreview = !showPreview">File preview</legend>\n	<div ng-if="showPreview">\n		<div cn-file-editor filename="/admin/files/{{file._id}}?contents&{{suffix}}" filetype="file.contentType"></div>\n	</div>\n</fieldset>\n<fieldset>\n	<legend>File actions</legend>\n	<button class="btn btn-success" ng-click="save()">Save</button>\n</fieldset>')}]),angular.module("files/featureprocessor/processor.modal.tpl.html",[]).run(["$templateCache",function(a){a.put("files/featureprocessor/processor.modal.tpl.html",'<div>\n  <div class="modal-header">\n    <h3>Select a file</h3>\n  </div>\n  <div class="modal-body">\n    <fieldset>\n      <legend>Folder: {{folder}}</legend>\n      <table class="table table-striped">\n        <tr>\n          <th>Filename</th>\n          <th>Content Type</th>\n        </tr>\n        <tr ng-show="folder !== \'/\'">\n          <td><a ng-click="switchTo(\'/\')">..</td>\n          <td></td>\n        </tr>\n        <tr ng-repeat="file in files| filter:{ contentType: \'inode/directory\'}" ng-click="switchTo(file.filename)">\n          <td>{{file.filename}}</td>\n          <td>{{file.contentType}}</td>\n        </tr>\n        <tr ng-repeat="file in files| filter:{ contentType: \'!inode/directory\'}" ng-click="select(file)">\n          <td ng-class="{\'bg-success\': isSelected(file._id)}">{{file.filename}}</td>\n          <td ng-class="{\'bg-success\': isSelected(file._id)}">{{file.contentType}}</td>\n        </tr>\n      </table>\n    </fieldset>\n  </div>\n  <div class="modal-footer">\n    <button class="btn btn-primary" ng-click="ok()">OK</button>\n    <button class="btn btn-warning" ng-click="cancel()">Cancel</button>\n  </div>\n</div>')}]),angular.module("files/featureprocessor/processor.tpl.html",[]).run(["$templateCache",function(a){a.put("files/featureprocessor/processor.tpl.html",'<div ng-controller="FeatureProcessorFilesCtrl">\n	<button class="btn btn-success" ng-click="add()" style="width: 100%">Add files</button>\n</div>')}]),angular.module("files/field/file.config.tpl.html",[]).run(["$templateCache",function(a){a.put("files/field/file.config.tpl.html",'<div>\n	<label>Standard filepath (optional)</label>\n	<input type="text" placeholder="Filepath (e.g. /images)" ng-model="data.filepath" />\n</div>')}]),angular.module("files/field/file.selector.tpl.html",[]).run(["$templateCache",function(a){a.put("files/field/file.selector.tpl.html",'<div>\n  <div class="modal-header">\n    <h3>Select a file</h3>\n  </div>\n  <div class="modal-body">\n    <fieldset>\n      <legend>Folder: {{folder}}</legend>\n      <table class="table table-striped">\n        <tr>\n          <th>Filename</th>\n          <th>Content Type</th>\n        </tr>\n        <tr ng-show="folder !== \'/\'">\n          <td><a ng-click="switchTo(\'/\')">..</td>\n          <td></td>\n        </tr>\n        <tr ng-repeat="file in files| filter:{ contentType: \'inode/directory\'}" ng-click="switchTo(file.filename)">\n          <td>{{file.filename}}</td>\n          <td>{{file.contentType}}</td>\n        </tr>\n        <tr ng-repeat="file in files| filter:{ contentType: \'!inode/directory\'}" ng-click="select(file)">\n          <td ng-class="{success: selected == file}">{{file.filename}}</td>\n          <td ng-class="{success: selected == file}">{{file.contentType}}</td>\n        </tr>\n      </table>\n    </fieldset>\n  </div>\n  <div class="modal-footer">\n    <button class="btn btn-primary" ng-click="ok()">OK</button>\n    <button class="btn btn-warning" ng-click="cancel()">Cancel</button>\n  </div>\n</div>')}]),angular.module("files/field/file.tpl.html",[]).run(["$templateCache",function(a){a.put("files/field/file.tpl.html",'<div class="input-group" ng-controller="coreFileSelectorCtrl">\n	<span class="input-group-addon">{{options.label}}</span>\n	<input type="text" class="form-control" ng-model="data" />\n	<span class="input-group-addon" ng-click="browse()">Browse</span>\n</div>')}]),angular.module("files/files.tpl.html",[]).run(["$templateCache",function(a){a.put("files/files.tpl.html",'<div class="page-header">\n  <h1>Files <small><i class="icon-double-angle-right"></i> manage your files</small>\n  <div class="btn-group pull-right">\n    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">{{selectedBucket.name}} <span class="caret"></span></button>\n    <ul class="dropdown-menu" role="menu">\n      <li><a ng-click="selectBucket(standardBucket)">Standard</a></li>\n      <li ng-repeat="bucket in buckets"><a ng-click="selectBucket(bucket)">{{bucket.name}}</a></li>\n    </ul>\n  </div>\n  </h1>\n  <!-- Single button -->\n  <fieldset>\n    <legend>Actions</legend>\n    <div>\n      <div ng-controller="FileUploadCtrl">\n        <div ng-file-drop="onFileSelect($files)" ng-file-drag-over-class="bg-success" class="well text-center" ng-show="dropSupported">\n          <p>Drop files here or</p>\n          <button class="btn btn-success" ng-click="addFile()"><i class="fa fa-floppy-o"></i> Create new file</button>\n        </div>\n        <div ng-file-drop-available="dropSupported=true" ng-show="!dropSupported">HTML5 Drop File is not supported!</div>\n      </div>\n    </div>\n  </fieldset>\n  <fieldset>\n    <legend>Folder: {{folder}}</legend>\n    <table class="table table-striped">\n      <tr>\n        <th>Filename</th>\n        <th>Content Type</th>\n        <th>Actions</th>\n      </tr>\n      <tr ng-show="folder !== \'/\'">\n        <td><a ng-click="switchTo(\'/\')">..</td>\n        <td></td>\n        <td></td>\n      </tr>\n      <tr ng-repeat="file in files| filter:{ contentType: \'inode/directory\'}">\n        <td><a ng-click="switchTo(file.filename)">{{file.filename}}</a></td>\n        <td>{{file.contentType}}</td>\n        <td>\n          <a class="btn btn-warning" ng-click="edit(file)"><i class="fa fa-pencil"></i></button>\n        </td>\n      </tr>\n      <tr ng-repeat="file in files| filter:{ contentType: \'!inode/directory\'}">\n        <td><a ng-click="edit(file)">{{file.filename}}</a></td>\n        <td>{{file.contentType}}</td>\n        <td>\n          <a class="btn btn-warning" ng-click="edit(file)"><i class="fa fa-pencil"></i></a>\n          <button class="btn btn-danger" ng-click="remove(file)"><i class="fa fa-trash-o"></i></button>\n        </td>\n      </tr>\n    </table>\n  </fieldset>\n</div>')}]),angular.module("files/settings.tpl.html",[]).run(["$templateCache",function(a){a.put("files/settings.tpl.html",'<h1 class="page-header">Files management</h1>\n<blockquote>Your standard statics bucket is always published under /static, you can add more paths and buckets here.</blockquote>\n<table class="table table-striped">\n  <tr>\n    <th>Bucket name</th>\n    <th>Database</th>\n    <th>Actions</th>\n  </tr>\n  <tr ng-repeat="bucket in buckets">\n    <td>{{bucket.name}}</td>\n    <td>{{bucket.database}}</td>\n    <td>\n      <button class="btn btn-success" ng-click="edit(bucket)"><i class="fa fa-pencil"></i></button>\n      <button class="btn btn-danger" ng-click="remove(bucket, $index)"><i class="fa fa-trash-o"></i></button>\n    </td>\n  </tr>\n  <tr>\n    <td>\n      <input type="text" placeholder="New bucket name" ng-model="newBucket" class="form-control input-md">\n    </td>\n    <td>\n      <input type="text" placeholder="Database" ng-model="newDatabase" class="form-control input-md">\n    </td>\n    <td>\n      <button class="btn btn-success" ng-click="add(newBucket, newDatabase)"><i class="fa fa-plus"></i> Add</button>\n    </td>\n  </tr>\n</table>\n')}]),angular.module("files/viewer/image.tpl.html",[]).run(["$templateCache",function(a){a.put("files/viewer/image.tpl.html",'<img src="{{filename}}"></img>')}]),angular.module("files/viewer/less.tpl.html",[]).run(["$templateCache",function(a){a.put("files/viewer/less.tpl.html",'<div ng-controller="CoreLessController">\n	<div ui-codemirror="editorOptions" name="fileEditor" ng-model="fileContents"></div>\n	<button class="btn btn-success" ng-click="save()">Save contents</button>\n</div>')}]),angular.module("files/viewer/text.tpl.html",[]).run(["$templateCache",function(a){a.put("files/viewer/text.tpl.html",'<div ng-controller="CoreTextController">\n	<div ui-codemirror="editorOptions" name="fileEditor" ng-model="fileContents"></div>\n	<button class="btn btn-success" ng-click="save()">Save contents</button>\n</div>')}]);